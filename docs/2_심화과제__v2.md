# React SSR & SSG 구현

## 목표
- React renderToString SSR
- TypeScript 지원 SSG  
- Universal React 코드
- 안전한 Hydration

## 파일 구조
```
packages/react/
├── server.js                    # Express React SSR
├── static-site-generate.js      # React SSG
├── src/
│   ├── main-server.tsx         # React SSR 엔트리
│   ├── services/
│   │   ├── ssr-data.ts         # 서버 데이터 로딩
│   │   └── hydration.ts        # 클라이언트 hydration
│   └── router/router.ts         # Universal Router
└── vite.config.ts               # SSR 빌드 설정
```

## 1. React SSR 서버 (`server.js`)

**핵심 키워드:** renderToString, React hydration, TypeScript SSR

```javascript
app.use(async (req, res) => {
  const { html, head, initialData } = await render(url, query);
  
  const finalHtml = template
    .replace("<!--app-html-->", html)
    .replace("<!--app-head-->", head)
    .replace("</head>", `${initialDataScript}</head>`);
});
```

## 2. React SSR 렌더링 (`main-server.tsx`)

**핵심 키워드:** renderToString, React Router server, store initialization

```typescript
import { renderToString } from "react-dom/server";

export const render = async (url: string, query: QueryPayload) => {
  // 1. React Router 서버 초기화
  router.push(url);
  router.query = query;
  
  // 2. 페이지별 데이터 프리로딩
  let initialData = {};
  if (router.target === HomePage) {
    initialData = await loadHomePageData(url);
    productStore.dispatch(PRODUCT_ACTIONS.SETUP, initialData);
  } else if (router.target === ProductDetailPage) {
    initialData = await loadProductDetailData(router.params.id);
    productStore.dispatch(PRODUCT_ACTIONS.SET_CURRENT_PRODUCT, initialData);
  }
  
  // 3. React 컴포넌트 → HTML 문자열
  const html = renderToString(<App />);
  
  return { html, head, initialData };
};
```

## 3. 서버 데이터 로딩 (`ssr-data.ts`)

**핵심 키워드:** mock API, TypeScript interfaces, error handling

```typescript
export interface HomePageData {
  products: any[];
  categories: any[];
  totalCount: number;
}

export async function loadHomePageData(url: string): Promise<HomePageData | null> {
  const query = Router.parseQuery(new URL(url, 'http://localhost').search);
  
  const [productsData, categories] = await Promise.all([
    mockGetProducts(query),
    mockGetCategories()
  ]);
  
  return {
    products: productsData.products,
    categories,
    totalCount: productsData.pagination.total
  };
}

export async function loadProductDetailData(productId: string): Promise<ProductDetailData | null> {
  const product = await mockGetProduct(productId);
  
  // 관련 상품 로드
  const relatedProducts = product.category2 
    ? await mockGetProducts({ category2: product.category2, limit: 4 })
    : [];
  
  return { currentProduct: product, relatedProducts };
}
```

## 4. React Hydration (`hydration.ts`)

**핵심 키워드:** window.__INITIAL_DATA__, store restoration, cleanup

```typescript
export function hydrateFromServerData() {
  if (typeof window !== "undefined" && window.__INITIAL_DATA__) {
    const initialData = window.__INITIAL_DATA__;
    
    if (initialData.products && initialData.categories) {
      productStore.dispatch(PRODUCT_ACTIONS.SETUP, {
        products: initialData.products,
        categories: initialData.categories,
        totalCount: initialData.totalCount,
        loading: false,
        status: "done"
      });
    }
    
    if (initialData.currentProduct) {
      productStore.dispatch(PRODUCT_ACTIONS.SET_CURRENT_PRODUCT, initialData.currentProduct);
      if (initialData.relatedProducts) {
        productStore.dispatch(PRODUCT_ACTIONS.SET_RELATED_PRODUCTS, initialData.relatedProducts);
      }
    }
    
    delete window.__INITIAL_DATA__;
  }
}
```

## 5. Universal Router (`router.ts`)

**핵심 키워드:** MemoryRouter vs Router, server/client branching

```typescript
const createRouter = () => {
  if (typeof window === "undefined") {
    // 서버: MemoryRouter
    return new MemoryRouter();
  } else {
    // 클라이언트: BrowserRouter
    return new Router();
  }
};

export const router = createRouter();

router.addRoute("/", HomePage);
router.addRoute("/product/:id/", ProductDetailPage);
router.addRoute("*", NotFoundPage);

// 브라우저에서만 시작
if (typeof window !== "undefined") {
  router.start();
}
```

## 6. React SSG (`static-site-generate.js`)

**핵심 키워드:** build-time rendering, React components to static HTML

```javascript
async function generateStaticSite() {
  const template = await fs.readFile(`${DIST_DIR}/index.html`, "utf-8");
  const { render } = await import("./dist/react-ssr/main-server.js");
  
  const pages = await getPages(); // /, /404, /product/1/, ...
  
  for (const page of pages) {
    const rendered = await render(page.url, {});
    
    const initialDataScript = rendered.initialData 
      ? `<script>window.__INITIAL_DATA__ = ${JSON.stringify(rendered.initialData)};</script>`
      : "";
    
    const html = template
      .replace("<!--app-html-->", rendered.html)
      .replace("<!--app-head-->", rendered.head)
      .replace("</head>", `${initialDataScript}</head>`);
    
    await saveHtmlFile(page.filePath, html);
  }
}

async function getPages() {
  const products = await mockGetProducts({ limit: 20 });
  return [
    { url: "/", filePath: `${DIST_DIR}/index.html` },
    { url: "/404", filePath: `${DIST_DIR}/404.html` },
    ...products.products.map(p => ({
      url: `/product/${p.id}/`,
      filePath: `${DIST_DIR}/product/${p.id}/index.html`
    }))
  ];
}
```

## 구현 체크리스트
- [ ] React `renderToString` 서버 렌더링
- [ ] TypeScript SSR 모듈 빌드
- [ ] 서버/클라이언트 Router 분기
- [ ] React 상태관리 서버 초기화  
- [ ] `window.__INITIAL_DATA__` Hydration
- [ ] 서버 안전 React Hooks
- [ ] React 컴포넌트 정적 생성 (SSG)
- [ ] Hydration 불일치 방지
